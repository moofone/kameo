# Remote Link Lifecycle (Established + Died)

This shows the two hooks involved in link lifecycle:

- `on_link_established`: called when the link becomes active
- `on_link_died`: called when the linked actor is no longer reachable

For distributed actors, link death is typically driven by TCP/TLS socket termination.

## Minimal Pattern

1. Lookup the remote actor to get a `DistributedActorRef`.
2. Call `remote.link(&local_actor_ref)`.
3. Implement the hooks on the local actor.

```rust
use std::ops::ControlFlow;

use kameo::{Actor, ActorRef};
use kameo::error::ActorStopReason;
use kameo::message::{Context, Message};

#[derive(Actor)]
struct Supervisor {
    // store your current remote ref here if you want to reconnect in on_link_died
}

impl Supervisor {
    async fn attach_remote<A: Actor>(&self, remote: &kameo::remote::DistributedActorRef<A>, me: &ActorRef<Self>) {
        remote.link(me).await;
    }
}

impl kameo::actor::Actor for Supervisor {
    type Args = ();
    type Error = kameo::error::BoxError;

    fn on_link_established(
        &mut self,
        _me: kameo::actor::WeakActorRef<Self>,
        id: kameo::actor::ActorId,
    ) -> impl std::future::Future<Output = Result<ControlFlow<ActorStopReason>, Self::Error>> + Send {
        async move {
            // Link is active (for remote, this generally means the peer socket is connected).
            println!("link established: {id:?}");
            Ok(ControlFlow::Continue(()))
        }
    }

    fn on_link_died(
        &mut self,
        _me: kameo::actor::WeakActorRef<Self>,
        id: kameo::actor::ActorId,
        reason: ActorStopReason,
    ) -> impl std::future::Future<Output = Result<ControlFlow<ActorStopReason>, Self::Error>> + Send {
        async move {
            println!("link died: {id:?} reason={reason:?}");

            // For remote sockets, you will commonly see:
            // - ActorStopReason::PeerDisconnected
            // Handle reconnect here: lookup/refresh a new DistributedActorRef and re-link.

            Ok(ControlFlow::Continue(()))
        }
    }
}
```

Notes:

- If you want automatic recovery, do it in `on_link_died` (refresh/lookup + re-link).
- Stale `DistributedActorRef` clones intentionally fail after disconnect (they should not heal).

